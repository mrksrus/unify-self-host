services:
  # ── UniHub Application (Frontend + API) ─────────────────────────
  #
  # Default admin account (created automatically on first start):
  #   Email:    admin@unihub.local
  #   Password: admin123
  #
  # ⚠  Change the admin password immediately after first login:
  #    Settings → Security → Change Password
  #
  unihub:
    image: ghcr.io/mrksrus/unify-self-host:latest
    container_name: unihub
    restart: unless-stopped
    ports:
      - "3000:80"
    environment:
      NODE_ENV: production
      MYSQL_DATABASE: unihub
      MYSQL_USER: unihub
      MYSQL_PASSWORD: CHANGE_ME_db_password          # ← CHANGE THIS
      MYSQL_HOST: unihub-mysql
      MYSQL_PORT: "3306"
      # ── Required: set a strong, random secret ──────────────────────
      # Generate one with:  openssl rand -base64 48
      JWT_SECRET: ""                               # ← REQUIRED – fill this in
      # ── Encryption key for stored email passwords ──────────────────
      ENCRYPTION_KEY: CHANGE_ME_encryption_key     # ← CHANGE THIS
    depends_on:
      - unihub-mysql
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://localhost/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 210s   # Must exceed 120s MySQL wait in start.sh
    networks:
      - unihub-network
    volumes:
      - uploads_data:/app/uploads

  # ── MySQL Database ──────────────────────────────────────────────
  unihub-mysql:
    image: mysql:8.0
    container_name: unihub-mysql
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: unihub
      MYSQL_USER: unihub
      MYSQL_PASSWORD: CHANGE_ME_db_password         # ← MUST match above
      MYSQL_ROOT_PASSWORD: CHANGE_ME_root_password  # ← CHANGE THIS
      # Allow root access from other containers on the network
      MYSQL_ROOT_HOST: "%"
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --max-connections=100
    volumes:
      - mysql_data:/var/lib/mysql
    # Health check uses MYSQL_PWD to avoid YAML escaping issues
    healthcheck:
      test: ["CMD-SHELL", "MYSQL_PWD=$$MYSQL_ROOT_PASSWORD mysqladmin ping -h localhost -u root"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 120s
    networks:
      - unihub-network

networks:
  unihub-network:
    driver: bridge

volumes:
  mysql_data:
    driver: local
  uploads_data:
    driver: local
